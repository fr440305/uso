<!doctype html>
<!-- picpage -->
<html>
	<head>
		<meta charset='utf-8'>
		<meta name='viewport' content='width=300px,initial-scale=1'>
		<style>

#_APP_ {
	z-index: 0;
}

#_SEND_CONTENT_ {
	font-size: 16px;
	margin-right: 5%;
	margin-left: 5%;
	width: 90%;
}


#_CANV_MASK_ {
	opacity: 0.5;
	display: none;
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	background-color: white;
	height: 100%;
	z-index: 1;
}


#_SEND_OPTION_BOARD_ {
	left: 0;
	bottom: 0;
	width: 100%;
	height: 10%;
	display: none;
	position: absolute;
	text-align: right;
	z-index: 2;
}


#_CANV_PAINT_ {
	opacity: 0.5;
	display: none;
	position: absolute;
	left: 0;
	top: 0;
	background-color: gray;
	width: 100%;
	height: 90%;
	z-index: 3;
}


		</style>
	</head>
	<body>
		<div id="_SEND_OPTION_BOARD_">
			<input type='button' value='CANCEL' id='_SEND_CANCEL_'>
			<input type='button' value='SEND' id='_SEND_PAINT_CONFIRM_'>
		</div>
		<canvas id="_CANV_MASK_" width="100px" height="100px"></canvas>
		<canvas id="_CANV_PAINT_" width="100px" height="100px"></canvas>
		<div id='_APP_'>
			<input type='button' value='LIGHT' id='_LIGHT_'>
			<input type='button' value='DARK' id='_DARK_'>
			<div id='_ONLINER_BOARD_'> <span>在线人数：</span><span id='_ONLINER_'></span> </div>
			<div id="_TEST_">
				<img id="_IMG_TEST_"></img>
			</div>
			<div> <b> WebSocket </b> </div>
			<div id='_ONLINE_'>
				<span>received data:&nbsp;</span>
				<div id='_RECEIVED_'></div>
			</div>
			<div id='_SEND_BOARD_'>
				<hr />
				<p style="text-align:right;">
					<input type='button' value='DOODLE' id='_SEND_OPTION_'>
					<input type='button' value='SEND' id='_SEND_CONFIRM_'> </p>
				<p><input
					type='text'
					id='_SEND_CONTENT_'></p>
				<hr />
			</div>
		</div>
		<script type='text/javascript'>

_CANV_PAINT_.width = window.innerWidth;
_CANV_PAINT_.height = window.innerHeight * 0.9;
_CANV_MASK_.ontouchmove = function(e) {
	e.preventDefault();
}
_CANV_PAINT_.onmousedown = function () {
	_CANV_PAINT_.onmousemove = function (e) {
		//FIXME - screenX does not works very well.
		var _x = e.screenX;
		var _y = e.screenY;
		console.log(_x, ", ", _y);
		e.preventDefault();
		_CANV_PAINT_.getContext("2d").fillStyle = "green";
		_CANV_PAINT_.getContext("2d").fillRect(_x, _y, 5, 5);
	};
};
_CANV_PAINT_.onmouseup = function () {
	_CANV_PAINT_.onmousemove = undefined;
};
_CANV_PAINT_.addEventListener("touchmove", function(e) {
	var _x = e.changedTouches[0].pageX;
	var _y = e.changedTouches[0].pageY;
	console.log(_x, ", ", _y);
	e.preventDefault();
	_CANV_PAINT_.getContext("2d").fillStyle = "green";
	_CANV_PAINT_.getContext("2d").fillRect(_x, _y, 5, 5);
});
_DARK_.onclick = function () {
	document.body.style.backgroundColor = "#000";
	document.body.style.color = "#fff";
};
_LIGHT_.onclick = function () {
	document.body.style.backgroundColor = "#fff";
	document.body.style.color = "#000";
};
_SEND_OPTION_.onclick = function () {
	_SEND_OPTION_BOARD_.style.display = "block";
	_CANV_MASK_.style.display = "block";
	_CANV_PAINT_.style.display = "block";
};
_SEND_CANCEL_.onclick = function () {
	var w = _CANV_PAINT_.width;
	var h = _CANV_PAINT_.height;
	_CANV_PAINT_.getContext("2d").clearRect(0, 0, w, h);
	_CANV_MASK_.style.display = "none";
	_CANV_PAINT_.style.display = "none";
	_SEND_OPTION_BOARD_.style.display = "none";
}
if (window.WebSocket != undefined) {
	//change the abs-url to document.host:
	var ws_conn = new WebSocket("ws://" + document.location.host + "/ws");
	_TEST_.innerHTML += "<p> +++ client-WebSocket </p>";
	ws_conn.onopen = function () {
		var json_msg = {
			"source_node":"",
			"description":"user-login",
			"content":[]
		};
		_TEST_.innerHTML += "<p>+++ Server-websocket</p>";
		//ws_conn.send("_NEW_CLIENT_"); // will be a json. //should get rid of this line.
		ws_conn.send(JSON.stringify(json_msg)); // will be a json.

		_RECEIVED_.innerHTML += ("<p>Connection Opened.</p>");
	};
	ws_conn.onmessage = function(e) {
		//e.data will be jsonlified later on.
		//_RECEIVED_.innerHTML += ("<p>" + e.data + "</p>"); //test mode.
		var msg_content = JSON.parse(e.data);
		var msg_desp = "";
		if (msg_content["description"] !== undefined) {
			msg_desp = msg_content["description"];
		} else {
			//error: no description.
		}
		if (msg_desp === "user-login-0") {
			msg_content = msg_content["content"]; // now, msg_content is a string array.
			for (var i = 0; i < msg_content.length; i++) {
				_RECEIVED_.innerHTML += ("<p>" + msg_content[i] + "</p>");
			}
		} else if (msg_desp === "user-login-*") {
			msg_content = msg_content["content"][0]; // now, msg_content is a string array.
			_ONLINER_.innerHTML = msg_content;
		} else if (msg_desp === "user-msg-text-0") {
			// ... //
		} else if (msg_desp === "user-msg-text-*") {
			msg_content = msg_content["content"]; // now, msg_content is a string array.
			for (var i = 0; i < msg_content.length; i++) {
				_RECEIVED_.innerHTML += ("<p>" + msg_content[i] + "</p>");
			}
		} else if (msg_desp === "user-logout-*") {
			msg_content = msg_content["content"][0]; // now, msg_content is a string array.
			_ONLINER_.innerHTML = msg_content;
		} else {
			//error: invalid msg.
		}


	};
	ws_conn.onerror = function (e) {
		_TEST_.innerHTML += ("<p>" + e.data + "</p>");
	};
	ws_conn.onclose = function () {
		//The sever crash???
		//ws_conn has been closed in this time.
		_TEST_.innerHTML += "<p> ~~~ </p>";
		_RECEIVED_.innerHTML += ("<p>Connection Closed.</p>");
	};
	//To allow the user to send the messages by pressing enter.
	_SEND_CONTENT_.onkeyup = function (e) {
		e = e || windows.event;
		e = e.keyCode || e.which;
		if (e === 13) {
			_SEND_CONFIRM_.onclick();
			_SEND_CONTENT_.click();
		}
	};
	_SEND_PAINT_CONFIRM_.onclick = function () {
		console.log(_CANV_PAINT_.toDataURL());
		_IMG_TEST_.src = _CANV_PAINT_.toDataURL();
	};
	_SEND_CONFIRM_.onclick = function () {
		var json_msg = {
			"source_node":"",
			"description":"user-msg-text",
			"content":[]
		};
		if (_SEND_CONTENT_.value != '') {
			json_msg["content"].push(_SEND_CONTENT_.value);
			ws_conn.send(JSON.stringify(json_msg));
			_SEND_CONTENT_.value = '';
			_SEND_CONTENT_.click();
			_SEND_CONTENT_.focus();
		}
	};
} else {
	_TEST_.innerHTML += (
		"<p>No WebSocket Util Supported. </p>" 
		+"<p> 肥肠抱歉~ 您的浏览器是个战五渣呢。</p>"
		+"<p> 强烈建议您使用谷歌浏览器或者火狐浏览器。</p>"
	);
}



		</script>
	</body>
</html>
