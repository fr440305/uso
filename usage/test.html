<!doctype html>

<html>
<head>
	<meta charset='utf-8' name='viewport' content='initial-scale=1.0;'>
	<title>.test</title>
</head>
<body>

<div id='_HALL_'>
	<p>/ Hall /</p>
	<span id='_HALL_how_many_'></span>
	<div id='_HALL_rooms_'></div>
</div>

<div id='_ROOM_'>
	<p>/ <span id='_ROOM_NAME'></span> /</p>
</div>




<script type='text/javascript'>


// client.js

//===========
//--message--
//===========

var UsoMsg_ToRoom   = "um:inr" // ["um:inr", <room name>, <uso name>]
var UsoMsg_AddRoom  = "um:++r" // ["um:++r", <room name>]
var UsoMsg_ExitRoom = "um:exr" // ["um:exr"]
var UsoMsg_Say      = "um:say" // ["um:say", <dialog>]
// var UsoMsg_Die      = "um:die" // ["um:die"]

var HallHorn_UsoToHall   = "hh:uinh" // ["hh:uinh", <len of connpool>]
var HallHorn_UsoExitHall = "hh:uexh" // ["hh:uexh", <len of connpool>]
var HallHorn_UsoAddRoom  = "hh:u++r" // ["hh:u++r", <room name>]
var HallHorn_DelRoom     = "hh:r--"  // ["hh:r--", <room 1>, <room 2>, ..., <room n>]

var HallResp_Rooms = "hr:rooms" // ["hr:rooms", <room 1>, <room 2>, ... , <room n>]
var HallResp_Error = "hr:err"   // ["hr:err", <error description>]

var RoomHorn_UsoToRoom   = "rh:uinr" // ["rh:uinr", <uso name>]
var RoomHorn_UsoExitRoom = "rh:uexr" // ["rh:uexr", <member 1>, <member 2>, ... , <member n>]
var RoomHorn_UsoSay      = "rh:usay" // ["rh:usay", <uso name>, <dialog>]

var RoomResp_Members = "rr:mems" // ["rr:mems", <member 1>, <member 2>, ... , <member n>]
var RoomResp_Hist    = "rr:hist" // ["rr:hist", <uso 1>, <dialog 1>, <uso 2>, <dialog 2>, ... , <uso n>, <dialog n>]
var RoomResp_Error   = "rr:err"  // ["rr:err", <description>]


//==========
//--client--
//==========

function Usoclient (url, msg_callback) {
	var client = this;
	if (WebSocket === undefined) {
	} else {
		this.wsclient = new WebSocket(url);
		this.wsclient.onmessage = function (e) {
			msg_callback(client, JSON.parse(e.data))
		}
	}
}

Usoclient.prototype.AddRoom = function (room_name) {
	this.send([UsoMsg_AddRoom, room_name])
}

Usoclient.prototype.ToRoom = function (room_name, my_name) {
	this.send([UsoMsg_ToRoom, room_name, my_name])
}

Usoclient.prototype.ExitRoom = function () {
	this.send([UsoMsg_ExitRoom])
}

Usoclient.prototype.Say = function (dialog) {
	this.send([UsoMsg_Say, dialog])
}

// @ param message : []string
Usoclient.prototype.send = function(message) {
	this.wsclient.send(JSON.stringify(message))
	console.log("Client->", JSON.stringify(message))
}


//===========
//--handler--
//===========

var Handler_seq = {};

Handler_seq[HallHorn_UsoToHall] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[HallHorn_UsoExitHall] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[HallHorn_UsoAddRoom] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[HallHorn_DelRoom] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[HallResp_Rooms] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[HallResp_Error] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[RoomHorn_UsoToRoom] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[RoomHorn_UsoExitRoom] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[RoomHorn_UsoSay] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[RoomResp_Members] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[RoomResp_Hist] = function (client, msg) {
	console.log("Handler:", msg)
};
Handler_seq[RoomResp_Error] = function (client, msg) {
	console.log("Handler:", msg)
};

function MessageHandler (client, msg) {
	var ty = msg.shift();
	var co = msg;
	console.log("Server: ty:", ty, "co:", co);
	var hf = Handler_seq[ty];
	console.log("Handler:hf:", hf)
	if (hf === undefined) {
		console.log("Server Message Error.");
	} else {
		hf(client, co);
	}
}

var C = new Usoclient ("ws://" + document.location.host + "/uso/conn", MessageHandler);


</script>

</body>
</html>
