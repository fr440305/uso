<!doctype html>

<html>
<head>
	<meta charset='utf-8' name='viewport' content='initial-scale=1.0;'>
	<title>.test</title>
</head>
<body>

<div id='_HALL_'>
	<p>/ Hall /</p>
	<span id='_HALL_how_many_'></span>
	<div id='_HALL_rooms_'></div>
	<p> New Room: <input id='_HALL_newroom_'> </p>
	<p> Your Name: <input id='_HALL_myname_'> </p>
	<p> <button id='_HALL_newroom_comfirm_'> Comfirm </button> </p>
	
</div>
<hr />

<div id='_ROOM_'>
	<p>/ <span id='_ROOM_name_'></span> /</p>
	<button id='_ROOM_exit_'> Exit </button>
	<input id='_ROOM_dialog_' type='text'>
	<button id='_ROOM_dialog_send_'>Send</button>
	<div id='_ROOM_member_'> </div>
	<div id='_ROOM_diapool_'> </div>
</div>




<script type='text/javascript'>
//===========
//--ui-hall--
//===========
function Hall_Show () {
}
function Hall_Hide () {
}
function Hall_ClearRooms () {
}
function Hall_InsertRoomButton(roomname, click_callback) {
	_HALL_rooms_.appendChild((function(){
		var p = document.createElement("p");
		var r = document.createElement("button");
		r.appendChild(document.createTextNode(roomname));
		r.onclick = click_callback;
		p.appendChild(r);
		return p;
	})())
}

//===========
//--ui-room--
//===========
function Room_Show () {
}
function Room_Hide () {
}
function Room_InsertDialog (speaker, content) {
}
function Room_ClearDialogs () {
}
function Room_InsertMember (name) {
}
function Room_ClearMembers () {
}

// client.js

//===========
//--message--
//===========

var UsoMsg_ToRoom   = "um:inr" // ["um:inr", <room name>, <uso name>]
var UsoMsg_AddRoom  = "um:++r" // ["um:++r", <room name>]
var UsoMsg_ExitRoom = "um:exr" // ["um:exr"]
var UsoMsg_Say      = "um:say" // ["um:say", <dialog>]
// var UsoMsg_Die      = "um:die" // ["um:die"]

var HallHorn_UsoToHall   = "hh:uinh" // ["hh:uinh", <len of connpool>]
var HallHorn_UsoExitHall = "hh:uexh" // ["hh:uexh", <len of connpool>]
var HallHorn_UsoAddRoom  = "hh:u++r" // ["hh:u++r", <room name>]
var HallHorn_DelRoom     = "hh:r--"  // ["hh:r--", <room 1>, <room 2>, ..., <room n>]

var HallResp_Rooms = "hr:rooms" // ["hr:rooms", <room 1>, <room 2>, ... , <room n>]
var HallResp_Error = "hr:err"   // ["hr:err", <error description>]

var RoomHorn_UsoToRoom   = "rh:uinr" // ["rh:uinr", <uso name>]
var RoomHorn_UsoExitRoom = "rh:uexr" // ["rh:uexr", <member 1>, <member 2>, ... , <member n>]
var RoomHorn_UsoSay      = "rh:usay" // ["rh:usay", <uso name>, <dialog>]

var RoomResp_Members = "rr:mems" // ["rr:mems", <member 1>, <member 2>, ... , <member n>]
var RoomResp_Hist    = "rr:hist" // ["rr:hist", <uso 1>, <dialog 1>, <uso 2>, <dialog 2>, ... , <uso n>, <dialog n>]
var RoomResp_Error   = "rr:err"  // ["rr:err", <description>]


//==========
//--client--
//==========

function Usoclient (url, msg_callback) {
	var client = this;
	if (WebSocket === undefined) {
	} else {
		client.wsclient = new WebSocket(url);
		client.wsclient.onmessage = function (e) {
			msg_callback(client, JSON.parse(e.data))
		}
	}
}
Usoclient.prototype.AddRoom = function (room_name) {
	this.send([UsoMsg_AddRoom, room_name])
}
Usoclient.prototype.ToRoom = function (room_name, my_name) {
	this.send([UsoMsg_ToRoom, room_name, my_name])
}
Usoclient.prototype.ExitRoom = function () {
	this.send([UsoMsg_ExitRoom])
}
Usoclient.prototype.Say = function (dialog) {
	this.send([UsoMsg_Say, dialog])
}

// @ param message : []string
Usoclient.prototype.send = function(message) {
	this.wsclient.send(JSON.stringify(message))
	console.log("Client->", JSON.stringify(message))
}


//===========
//--handler--
//===========

var Handler_seq = {};

Handler_seq [HallHorn_UsoToHall] = function (client, msg) {
	//console.log("Handler:", msg)
	_HALL_how_many_.innerText = msg[0];
};
Handler_seq [HallHorn_UsoExitHall] = function (client, msg) {
	//console.log("Handler:", msg)
	_HALL_how_many_.innerText = msg[0];
};
Handler_seq [HallHorn_UsoAddRoom] = function (client, msg) {
	//console.log("Handler:", msg)
	_HALL_rooms_.appendChild((function(){
		var p = document.createElement("p");
		var r = document.createElement("button");
		r.appendChild(document.createTextNode(msg[0]));
		r.onclick = function () {
			client.ToRoom(msg[0], _HALL_myname_.value)
		};
		p.appendChild(r);
		return p;
	})())
};
Handler_seq [HallHorn_DelRoom] = function (client, msg) {
	//console.log("Handler:", msg)
};
Handler_seq [HallResp_Rooms] = function (client, msg) {
	//console.log("Handler:", msg)
	_HALL_rooms_.innerHTML = "";
	_ROOM_name_.innerText = "";
	for (var i = 0; i < msg.length; i++) {
		_HALL_rooms_.appendChild((function(){
			var p = document.createElement("p");
			var r = document.createElement("button");
			r.appendChild(document.createTextNode(msg[i]));
			r.onclick = function () {
				client.ToRoom(msg[0], _HALL_myname_.value)
			};
			p.appendChild(r);
			return p;
		})())
	}

};
Handler_seq [HallResp_Error] = function (client, msg) {
	//console.log("Handler:", msg)
	alert(msg)
};
Handler_seq [RoomHorn_UsoToRoom] = function (client, msg) {
	_ROOM_member_.appendChild((function(){
		var m = document.createElement("p")
		m.appendChild(document.createTextNode(msg[0]));
		return m;
	})())
};
Handler_seq [RoomHorn_UsoExitRoom] = function (client, msg) {
	_ROOM_member_.innerHTML = "";
	for (var i = 0; i < msg.length; i++) {
		_ROOM_member_.appendChild((function(){
			var m = document.createElement("p")
			m.appendChild(document.createTextNode(msg[i]));
			return m;
		})())
	}
};
Handler_seq [RoomHorn_UsoSay] = function (client, msg) {
	_ROOM_diapool_.appendChild((function(){
		var d = document.createElement('p');
		d.appendChild(document.createTextNode(msg[0]))
		d.appendChild(document.createTextNode(' : '))
		d.appendChild(document.createTextNode(msg[1]))
		return d;
	})())
};
Handler_seq [RoomResp_Members] = function (client, msg) {
	_ROOM_member_.innerHTML = "";
	for (var i = 0; i < msg.length; i++) {
		_ROOM_member_.appendChild((function(){
			var m = document.createElement("p")
			m.appendChild(document.createTextNode(msg[i]));
			return m;
		})())
	}
};
Handler_seq [RoomResp_Hist] = function (client, msg) {
};
Handler_seq [RoomResp_Error] = function (client, msg) {
	alert(msg)
};

function MessageHandler (client, msg) {
	var ty = msg.shift();
	var co = msg;
	console.log("Server: ty:", ty, "co:", co);
	var hf = Handler_seq[ty];
	if (hf === undefined) {
		console.log("Server Message Error.");
	} else {
		hf(client, co);
	}
}

var C = new Usoclient ("ws://" + document.location.host + "/uso/conn", MessageHandler);
_HALL_newroom_comfirm_.onclick = function () {
	C.AddRoom(_HALL_newroom_.value)
}
_ROOM_exit_.onclick = function () {
	C.ExitRoom();
}
_ROOM_dialog_send_.onclick = function () {
	C.Say(_ROOM_dialog_.value)
}


</script>

</body>
</html>
